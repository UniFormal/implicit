\subsection{Overview}

The motivation behind implicit morphisms is to generalize the benefits of include declarations even further.
Sometimes an atomic morphism is conceptually similar to an inclusion: For example, we might want to declare $m:\cn{Division}\to\cn{Group}=\{\cn{divide} := \lambda x,y.x\circ y^{-1}, \;\ldots\}$ to show how division is ``included'' into the theory of groups.
Other times we have to use structures because we need to duplicate declarations but we would still like to use them like includes.
For example, we have to declare the theory of rings using two structures (for the commutative group and the monoid).
But we still want a ring to be implicitly converted into, e.g., a commutative group.

Our key idea is to use a commutative{\footnotemark} subdiagram of the \mmt diagram, which we call the \emph{implicit-diagram}.
It contains all theories but only some of the morphisms -- the ones designated as \emph{implicit}.
Because the implicit-diagram commutes, there can be at most one implicit morphism from $S$ to $T$ -- if this morphism is $M$, we write $\ipc{M}{S}{T}$.
\footnotetext{A diagram commutes if for any two morphisms $M,M'\in\Mo{S}{T}$, we have $M\equiv M'$.}
%Practically, this hasis a multi-graph whose nodes are the theories and whose edges are the atomic morphisms.
%We can extend the correspondence by identifying all paths with the composition of all edges along the path.
%Then concatenation of paths is just composition of morphisms, and the empty path from $T$ to itself is the identity morphism $\id{T}$.
%(This is well-defined because composition is associative and identity is neutral.)
%A diagram is commutative if any two paths between the same nodes are equal (with respect to $\equiv$), i.e., there is at most one morphism between any two nodes.

The implicit-diagram generalizes the inclusion relation $\harr$.
In particular, all identity and inclusion morphisms are implicit, and we recover $S\harr T$ as the special case $\ipc{\id{S}}{S}{T}$.
Moreover, the relation ``exists $M$ such that $\ipc{M}{S}{T}$'' is also an order.

Consequently, many of the advantages of inclusions carry over to implicit morphisms.
\begin{compactitem}
\item It is very easy to maintain the implicit-diagram, e.g., as a partial map that assigns to a pair of theories the implicit morphism between them (if any).
\item We can generalize the visibility of identifiers: If $\ipc{M}{S}{T}$, we can use all $S$-identifiers in $T$ as if $S$ were included into $T$.
Any $c\in\dom{S}$ is treated as a valid $T$-identifiers with definiens $M(c)$.
\item We can still use canonical identifiers $s?n$. Because there can be at most one implicit morphism $\ipc{M}{s}{T}$, using $s?n$ as an identifier in $T$ is unambiguous.
Crucially, we can use $s?n$ without bothering what $M$ is.
\end{compactitem}

%Thus the main question arises what other morphisms we should make implicit.

\subsection{Syntax}

We introduce the family of sets $\IMo{S}{T}$ as a subset of $\Mo{S}{T}$, holding the \textit{implicit} morphisms.
The intuition is that $\Thy$ and $\IMo{S}{T}$ (up to equality of morphisms) form a thin broad subcategory of $\Thy$ and $\Mo{S}{T}$.

It remains to define which morphisms are implicit.
For that purpose, we allow \mmt declarations to carry \textit{attributes}.
Precisely, we add the following productions
\begin{grammar}
MDec   & Att\; MDec  & \text{attributed morphism} \\
Dec    & Att\; Dec   & \text{attributed declaration}\\
Att    & \keyword{implicit} \alt \ldots & \text{attributes}
\end{grammar}

The set of attributes is itself extensible, and the above grammar only list the one that we use to get started.
Additional attributes may be added with the condition that any additional attribute increases the set of implicit morphisms.

Specifically, the set $\IMo{S}{T}\sq\Mo{S}{T}$ of \textbf{implicit} morphisms contains the following elements:
\begin{itemize}
 \item all identity morphisms $\id{T}$,
 \item all compositions $M;N$ of implicit morphisms $M$ and $N$,
 \item all declared morphisms $m:S\to T=\{\sigma\}$ whose declaration carries the attribute $\keyword{implicit}$.
\end{itemize}

\subsection{Semantics}

We only have to make two minor changes to the semantics to accommodate implicit morphisms.
The first change govern how we obtain implicit morphisms, the second one how we use them.

\paragraph{Obtaining}
We define well-formedness for our extended syntax.
We define that an attribute to a declaration is only well-formed if the category of implicit morphisms remains thin, i.e., for any two theories, there may be only one (up to equality) implicit morphism between them.
In other the diagram containing only the implicit morphisms must commute.

Depending on what modularity principles we add, equality of morphisms may or may not be decidable.
Therefore, in the general case, implementations may have to employ sound but incomplete criteria for commutativity (see Sect.~\ref{sec:commute}).

%\begin{definition}[Well-Formedness]
%Consider a well-formed diagram $D, m:S\to T=\{\sigma\}$.
%Let $D^a$ be $D, a\; m:S\to T=\{\sigma\}$.
%$D^{\keyword{implicit}}$ is well-formed if $D^i$ extended with an edge for $m$ commutes.
%$D^{\keyword{invertible}}$ is well-formed if $D^i$ extended with edges for $m$ and its inverse commutes.
%
%Correspondingly, consider a well-formed diagram $D$ of the form $D_0, T=\{\ldots,\icl{S},\ldots\}$.
%Let $D^a$ be $D_0, T=\{\ldots, a\; \icl{S},\ldots\}$.
%$D^{\keyword{invertible}}$ is well-formed if the inclusion has an *inverse.
%\end{definition}

\paragraph{Using}
We make a small modification to the rules in 

\begin{definition}[Visible Declarations]
The set $\flti{T}$ contains the following declarations:
for every $\ipc{M}{S}{T}$ and every $c[:t][=d]$ in $\flt{S}$, the declaration $c[:M(t)]=M(c)$.

The set $\Expi{T}$ contains all objects formed from the symbols in $\flti{T}$.
The map $M(-)$ maps every $c$ for which $\flt{M}$ does not provide an assignment to $M(d)$ where $d$ is the definiens of $c$.
\end{definition}

This modification is conservative in the sense that $\flt{T}\sq\flti{T}$ and $\flti{T}\sm\flt{T}$ contains only declarations with definiens.
Moreover, $\Exp{T}\sq\Expi{T}$ and $M(-)$ remains unchanged on all $o\in\Exp{T}$.
It is easy to see that $M(-)$ still preserve all judgments.

\subsection{Commutativity}\label{sec:commute}

To prove commutativity, we have to find all paths in the implicit-diagram and check $M\equiv M'$ for all pairs of morphisms between the same nodes.

\mmt reduces $M\equiv M'$ for $M,M'\in\Mo{S}{T}$ to a first-order problem in the theory of categories, which uses the following axioms:
\begin{compactitem}
\item associativity of composition,
\item neutrality of identity,
\item $M;M'\equiv \id{S}$ as well as $M';M\equiv\id{T}$ if $M\in\Mo{S}{T}$ and $M'$ is the known *inverse of $M$,
\item if an atomic morphism $m$ includes $M\in\Mo{R}{T}$, then $M|_R\equiv M$.
\end{compactitem}

This is a sound but not complete axiomatization of $M\equiv M'$.
We can obtain a complete axiomatization in a totally different way: Check $\der_T M(c)\equiv M'(c)$ for all $c\in\dom{S}$.
However, this can be extremely expensive: It requires computing $\dom{S}$ and proving an object level equality for each identifier.
Even if the equality of objects is decidable, this is often too expensive.

In fact, because implicit morphisms are meant to be used in very particular cases, we expect the above incomplete calculus to perform reasonably well in practice.
If showing the equality of certain morphisms is hard, one should probably not make them implicit in the first place.


\subsection{Inverse Morphisms}\label{sec:inverse}

We only two use sufficient criteria to determine an *inverse of a morphism $M$.

\paragraph{Conservative Extensions}
Intuitively, $t$ extends $S$ definitionally, if it only adds defined symbols, e.g., abbreviations or theorems.
That is the most important case of conservative extensions.

\begin{definition}[Definitional Extension]
An include declaration \[t=\{\keyword{invertible}\;\icl{S},\Sigma\}\] is \textbf{definitional} if
\begin{compactitem}
 \item all symbol declarations in $\Sigma$ have a definiens,
 \item all include declarations $\icl{R}$ in $\Sigma$ are such that $R$ also definitionally includes $S$.
\end{compactitem}
\end{definition}

There are multiple, subtly different definitions of conservative extension.
However, definitional extensions as defined above are always conservative (i.e., for any reasonable definition of conservativity and in any reasonable formal language).
In fact, they are always invertible: The inverse morphism $i:t\to S$ maps
\begin{compactitem}
 \item an identifier $c\in\dom{S}$ to $c$ and everythemselves and the others to their definiens,
 \item any other identifier, which must have a definiens $d$, to $i(d)$.
\end{compactitem}

%We use two auxiliary definitions.
%Given $u:T\to U$, we write $u|_S$ for the restriction of $u$ to $S$, i.e., the composition of the inclusion $S\harr T$ and $u$.
%An extension $S\to T$ is retractable if there is a morphism $r:T\to S$ such that $r|_S=\id{S}$.
%
%Whether a given extension $S\harr T$ is conservative depends on the specific definition of conservativity and the used logic.
%However, the most important kind of conservative extension is very easy to handle: the extension of a theory with a defined constant (e.g., an abbreviation or a theorem).
%These extensions are always conservative (i.e., for any reasonable definition of conservativity and in any reasonable logic).
%In fact, they are always isomorphic to the original theory.
%
%Extensions with definition are almost exclusively used to add something to $S$.
%Therefore, it is reasonable to automatically designate the retraction as implicit.
%In particular, this provides an elegant way to add theorems to $S$ in such a way that they are available to any theory importing $S$, but without actually changing $S$.
%
%More generally, any retractable extension $S\harr T$ is always conservative.
%But if the retraction usually does not exist uniquely (Often an arbitrary non-canonical choice is needed, e.g., any type.), this is not enough to make the retraction implicit.

\paragraph{Renamings}
Intuitively, an atomic morphism $m:S\to T$ is a renaming if it maps all $S$-identifiers to $T$-identifiers (rather than $T$-objects).

\begin{definition}[Renaming]
Consider a morphism $M\in\Mo{S}{T}$.
Let $A\sq\dom{S}$ and $B\sq\dom{T}$ contain those identifiers without definiens.
$M$ is an (injective, surjective) \textbf{renaming} if the restriction of $M(-)$ is an (injective, surjective) mapping $A\to B$.
\end{definition}

Clearly, if $m$ is an injective and surjective renaming, it is straightforward to obtain its inverse by inverting $M(-)$.

